{% load staticfiles %} {% include 'navbar.html' %}
<script>
	$(document).ready(function() {
		// ###### Form updating #########
		function updateForm() {
			$(".table").find("input").each(function() {
				var amount = $(this).val();
				var name = $(this).attr("name");
				var price = $(".price." + name).text().slice(1, 4);
				var total = (amount * price).toFixed(2);
				$(".total." + name).text("£"+total);

			});
			var totalPounds = 0.0;
			$(".table").find(".total").each(function() {
				console.log($(this).text().substring(1));
				totalPounds += parseFloat($(this).text().substring(1));
				console.log(totalPounds);
			});
			$("#total").text("£"+totalPounds);
		};

		// Function to update VIP seats amount called from Seat selection code
		function updateVipAmount() {
			var amount = $(".theatre").find(".taken").filter(".vip").length;
			$('.amount.vip').text(amount);
			var price = $(".price.vip").text().substring(1);
			$(".total.vip").text("£"+(price*amount).toFixed(2));
		}
		// ###### Sliding of the form #######

		$("#next").click(function() {
			$(".form1").fadeOut(200, function() {
				$(".form2").fadeIn(200);
				$(".table input").prop("disabled",true);
				$("#next").prop("disabled",true);
				$("#previous").prop("disabled",false);
			});
		});
		$("#previous").click(function() {
			$(".form2").fadeOut(200, function() {
				$(".form1").fadeIn(200);
				$(".table input").prop("disabled",false);
				$("#next").prop("disabled",false);
				$("#previous").prop("disabled",true);
			});
		});


		// ###### SEAT SELECTION CODE ##########
		vipSeats = {{screen.vipSeats}};
		standardSeats = {{screen.standardSeats}};
		clickedSeats = 0;
		seatSelected = []
		seatReserved = []
		getLiveSeats();

		// ## Generate the graphical seats
		for (i = 0; i < vipSeats; i++) {
			row = Math.floor(i / 10);
			column = i % 10;
			$(".theatre").append("<div class='seat free vip' data-column=" + column + " data-row=" + row + " ></div><!--");
		}
		for (i = 0; i < standardSeats; i++) {
			row = Math.floor(i / 10) + Math.floor(vipSeats / 10);
			column = i % 10;
			$(".theatre").append("<div class='seat free' data-column=" + column + " data-row=" + row + "></div><!--");
		}
		// ## On form/input change, check the number of seats
		$(".form-control").on("change paste keyup", function() {
			updateForm();
			totalSeats = getTotalSeats();
			if (seatSelected.length > totalSeats) {
				seatRemoveFIFO(seatSelected.length - totalSeats);
			}
		});
		// ## When a seat is clicked
		$(".seat").click(function() {
			row = $(this).data("row");
			column = $(this).data("column");
			seatPos = String(row) + String(column);
			totalSeats = getTotalSeats();
			if (totalSeats > 0) {
				// If the seat is not already reserved (by somebody else)
				if (seatReserved.indexOf(seatPos) < 0) {
					// #1 If the seat is not already selected
					if (seatSelected.indexOf(seatPos) < 0) {
						// #1.1 If the seat limit is reached, remove one seat
						if (seatSelected.length >= totalSeats) {
							seatRemoveFIFO(1);
						}
						// change the clicked seat and add it to the list
						seatRedraw(seatPos, "taken");
						seatSelected.push(seatPos);
						updateVipAmount();
					}
					// #2 If the seat is already clicked -> remove the seat
					else {
						seatRemovePos(seatPos);
						seatRedraw(seatPos, "free");
					}
					displaySeats();
				}
			}
			// If no seats were chosen but a seat was clicked
			else {
				alert("Please choose the amount of seats required");
			}
		})
		// Returns a number of seats selected in the Form
		function getTotalSeats() {
			total = 0;
			$(".form-control").each(function() {
				if (parseInt($(this).val()) > 0) {
					total += parseInt($(this).val());
				}
			})
			return total;
		}
		// Updates the seats numbers displayed for user
		function displaySeats() {
			$(".seats").empty();
			for (i = seatSelected.length - 1; i >= 0; i--) {
				seat = ""
				if (seatSelected[i].slice(0, 1) == "0") {
					seat = seatSelected[i].slice(1, 2);
				} else {
					seat = seatSelected[i];
				}
				seat = String(parseInt(seat) + 1);
				$(".seats").append("<span style='font-size:20px;'>" + seat + ",</span> ");
			}
		}
		// First In First Out seat removal function
		function seatRemoveFIFO(amount) {
			// get first seat, FIFO
			for (i = 0; i < amount; i++) {
				removeMe = seatSelected.shift();
				seatRedraw(removeMe, "free");
			}
		}

		function seatRemovePos(position) {
			var index = seatSelected.indexOf(position);
			if (index >= 0) {
				seatSelected.splice(index, 1);
			}
		}

		window.setInterval(function() {
			getLiveSeats();
		}, 5000);

		function getLiveSeats() {
			$.getJSON("/api/seatingapi/{{screening.id}}/", function(data) {
				// Print live data
				console.log("\n###### Fresh from API ##### \n");
				string = "Seats reserved: ";
				$.each(data, function(key, val) {
					string += val.row + ":" + val.column + ", ";
				});
				console.log(string);
				// Clear reserved seats
				for (i = 0; i < seatReserved.length; i++) {
					seatRedraw(seatReserved[i], "free");
				}
				seatReserved = [];
				// Parse new data
				$.each(data, function(key, val) {
					seatReserved.push(String(val.row) + String(val.column));
				});
				// Reverse clicked overlapping seats
				removedString = "";
				for (i = 0; i < seatReserved.length; i++) {
					if (seatSelected.indexOf(seatReserved[i]) >= 0) {
						seatRemovePos(seatReserved[i]);
						removedString += seatReserved[i] + ", ";
					}
				}
				if (removedString.length > 1) {
					$("#seatAlertNum").append(removedString);
					$("#seatAlert").fadeIn("slow");
					window.setTimeout(function() {
						$("#seatAlert").fadeOut("fast");
					}, 6000);
				}
				// Updates the clicked seats
				displaySeats();
				// Draw all seats
				for (i = 0; i < seatReserved.length; i++) {
					seatRedraw(seatReserved[i], "reserved");
				}
			});
		}

		// Updates a seat on the screen
		function seatRedraw(position,cls) {
			row = position.slice(0, 1);
			column = position.slice(1, 3);
			var seat =	$(".seat[data-row=" + row + "][data-column=" + column + "]");
			var vip = "";
			if (seat.hasClass("vip")){
				vip = "vip"
			}
			seat.removeClass();
			seat.addClass("seat " + cls +" "+ vip);
		}
	});
</script>
<link rel="stylesheet" href="{% static 'css/booking.css' %}">
<div class="alert alert-danger" id="seatAlert">
	We are sorry but it seems that the seat <strong id="seatAlertNum"></strong> has just been booked.
</div>
<div class="container">
	<div class="row formMain">
		<form  action="/checkout/" method="post">
		<div class="col-lg-12 col-xs-12">

			<div class="row">
				<div class="col-lg-4" style="text-align:center;">
					<img src="{% static movie.cover %}" style="width:100%" />
				</div>
				<div class="col-lg-8">
					<h1>{{movie.title}}</h1>
					<hr style="simpleHR">
					<div class="form-group">
						<table class="table" style="text-align:center">
							<thead>
								<tr>
									<th scope="col">Type</th>
									<th scope="col" style="text-align:center">Amount</th>
									<th scope="col" style="text-align:center">Price</th>
									<th scope="col" style="text-align:center">Total</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<th scope="row">Normal</th>
									<td><input class="form-control" type="number" name="normal" min="0" max="99" value="0" id="normal"></td>
									<td class="price normal">£5.60</td>
									<td class="total normal">£0.00</td>
								</tr>
								<tr>
									<th scope="row">Student</th>
									<td><input class="form-control" type="number" name="student" min="0" max="99" value="0" id="student"></td>
									<td class="price student">£4.00</td>
									<td class="total student">£0.00</td>
								</tr>
								<tr>
									<th scope="row">Senior</th>
									<td><input class="form-control" type="number" name="senior" min="0" max="99" value="0" id="senior"></td>
									<td class="price senior">£3.00</td>
									<td class="total senior">£0.00</td>
								</tr>
								<tr>
									<th scope="row">Child</th>
									<td><input class="form-control" type="number" name="child" min="0" max="99" value="0" id="child"></td>
									<td class="price child">£3.40</td>
									<td class="total child">£0.00</td>
								</tr>
								<tr>
									<th scope="row">VIP</th>
									<td class="amount vip"></td>
									<td class="price vip">£2.00</td>
									<td class="total vip">£0.00</td>
								</tr>
								<tr>
									<th scope="row"><h2><b>Total</b></h2></th>
									<td></td>
									<td ></td>
									<td id="total"><h2><b>£0.00</b></h2></td>
								</h2>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="row form1" style="padding: 30px 0px 30px 0px;text-align:center">
				<div class="col-lg-6 col-lg-offset-1 col-md-6 col-md-offset-1 ">
					<h1> Theatre {{ screen.id }}</h1>
					<div class="theatre"></div>
				</div>
				<div class="col-lg-4 col-md-4">
					<h1>Legend</h1>
					<hr>
					<br>
					<div class="seat free legend"></div> Standard Avaiable
					<br>
					<div class="seat freevip legend"></div> VIP Avaiable
					<br>
					<div class="seat reserved legend"></div> Reserved
					<h2> Seats Selected</h2>
					<p class="seats"></p>
					<br><br>

				</div>
			</div>
			<div class="row form2" style="display:none">
				<div class="col-sm-8 col-sm-offset-2">
					<div class="tab-content">
						<div id="stripe" class="tab-pane fade in active">
							<br>
							<div class='form-row'>
								<div class='form-group required'>
									<div class='error form-group hide'>
										<div class='alert-danger alert'>
										</div>
									</div>
									<label class='control-label'>Name on Card</label>
									<input class='form-control' size='4' type='text'>
								</div>
							</div>
							<div class='form-row'>
								<div class='form-group card required'>
									<label class='control-label'>Card Number</label>
									<input autocomplete='off' class='form-control card-number' size='20' type='text'>
								</div>
							</div>
							<div class='form-row'>
							</div>
							<div class='form-row'>
								<div class='form-group cvc required'>
									<label class='control-label'>CVC</label>
									<input autocomplete='off' class='form-control card-cvc' placeholder='ex. 311' size='4' type='text'>
								</div>
								<div class="form-group">
									<label for="sel1">Expiry Date</label>
									<form action="" class="form-horizontal">
										<div class="form-group">
											<div class="col-sm-8">
												<input type="text" class="form-control" placeholder="YYYY">
												<br>
											</div>
											<div class="col-sm-4">
												<input type="text" class="form-control" placeholder="MM">
											</div>
										</div>
									</form>
								</div>
							</div>
							<div class='form-row'>
								<div class='form-group'>
									<label class='control-label'></label>
									<button class='form-control btn btn-primary' type='submit' > Continue </button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row" style="padding:20px">
				<div class="col-lg-12">
					<button id="next" type="button" style="float:right" class="btn btn-warning">Continue</button>
					<button id="previous" type="button" style="float:left" class="btn btn-warning" disabled="">Go back</button>
				</div>
			</div>
		</div>
	</div>
</div>
{% include 'footer.html' %}
