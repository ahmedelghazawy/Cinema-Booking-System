{% load staticfiles %}
{% include 'navbar.html' %}
<script>
$(document).ready(function(){
    vipSeats = {{screen.vipSeats}}
	standardSeats = {{ screen.standardSeats}}
	clickedSeats = 0;
	seatSelected = []
	seatReserved = []


	// Initialize the seatSelected
	// seatSelected = new Array((vipSeats + standardSeats)/10);
	// for (i=0;i < (vipSeats + standardSeats)/10; i++){
	// 	seatSelected[i] =[0,0,0,0,0,0,0,0,0,0];
	// }
	// ## Generate the seats
	for ( i = 0; i < vipSeats; i++){
		row = Math.floor(i/10);
		column = i%10;
		$(".theatre").append("<div class='seat freevip' data-column="+column+" data-row="+row+" ></div><!--");
	}
	for ( i = 0; i < standardSeats; i++){
		row = Math.floor(i/10) + Math.floor(vipSeats/10);
		column = i%10;
		$(".theatre").append("<div class='seat free' data-column="+column+" data-row="+row+"></div><!--");
	}
	// ## On form/input change, check the number of seats
	$(".form-control").on("change paste keyup", function() {
		totalSeats = getTotalSeats();
		if (seatSelected.length > totalSeats){
			seatRemove(seatSelected.length - totalSeats);
		}
	});
	// ## When a seat is clicked
	$(".seat").click(function(){
		getLiveSeats();
		row = $(this).data("row");
		column = $(this).data("column");
		seatPos = String(row)+String(column);
		totalSeats = getTotalSeats();
		if (totalSeats > 0){
			// If the seat is not already reserved
			if (seatReserved.indexOf(seatPos)<0){
				// #1 If the seat is not already clicked
				if (seatSelected.indexOf(seatPos)<0){
					// #1.1 If the seat limit is reached, remove one seat
					if (seatSelected.length >= totalSeats){
						seatRemove(1);
					}
					// change the clicked seat and add it to the list
					$(this).css("background-color","black");
					seatSelected.push(seatPos);
				}
				// #2 If the seat is already clicked -> remove the seat
				else{
					var index = seatSelected.indexOf(seatPos);
					if (index >= 0) {
					  seatSelected.splice( index, 1 );
					}
					$(".seat[data-row="+row+"][data-column="+column+"]").css("background-color","white");
				}
				displaySeats();
			}
		}
	})
	// Returns a number of seats
	function getTotalSeats() {
    	total = 0;
		$(".form-control").each(function(){
			if (parseInt($(this).val())>0){
				total += parseInt($(this).val());
			}
		})
		return total;
	}
	// Updates the seats numbers displayed for user
	function displaySeats(){
		$(".seats").empty();
		for (i=seatSelected.length-1 ; i>=0;i--){
			seat = ""
			if (seatSelected[i].slice(0,1)== "0"){
				seat = seatSelected[i].slice(1,2);
			}else{
				seat = seatSelected[i];
			}
			seat = String(parseInt(seat)+1);
			$(".seats").append("<span style='font-size:20px;'>"+seat+",</span> ");
		}
	}
	// First In First Out seat removal function
	function seatRemove(amount){
		// get first seat, FIFO
		for (i=0;i<amount;i++){
			removeMe = seatSelected.shift();
			row = removeMe.slice(0,1);
			column = removeMe.slice(1,3);
			// remove seat with given row and column
			$(".seat[data-row="+row+"][data-column="+column+"]").css("background-color","white");
		}
	}

	function getLiveSeats(){
		$.getJSON( "/api/seatingapi/2144", function( data ) {
		var items = [];
			$.each( data, function( key, val ) {
				console.log(key +"  " + val.row);
			});
		});
	}

});
</script>
<link rel="stylesheet" href="{% static 'css/booking.css' %}">
<div class="container">
	<div class = "row">
		<div class="col-lg-3" style="text-align:center;">
			<img src="{% static movie.cover %}" style="width:100%"/>
		</div>
		<div class="col-lg-9">
			<h1>{{movie.title}}</h1>
			<hr style="simpleHR">
			<div class="form-group">
				<label for="normal">Normal:</label>
				<input class="form-control" type="number" name="Normal" min="0" max="99" value="0" id="normal">
				<label for="student">Student:</label>
				<input class="form-control" type="number" name="Student" min="0" max="99" value="0" id="student">
				<label for="senior">Senior:</label>
				<input class="form-control" type="number" name="Senior" min="0" max="99" value="0" id="senior">
				<label for="child">Child:</label>
				<input class="form-control" type="number" name="Child" min="0" max="99" value="0" id="child">
			</div>
			Total:
		</div>
	</div>
	<div class="row" style="padding: 30px 0px 30px 0px;text-align:center">
		<div class="col-lg-6 col-lg-offset-2 col-md-6 col-md-offset-2 ">
			<h1> Theatre {{ screen.id }}</h1>
			<div class="theatre"></div>
		</div>
		<div class="col-lg-4 col-md-4">
			<h1>Legend</h1>
			<hr>
			<br>
			<div class="seat free legend"></div> Standard avaiable
			<br>
			<div class="seat freevip legend"></div> VIP Avaiable
			<br>
			<div class="seat reserved legend"></div> Reserved
			<h2> Seats Selected</h2>
			<p class="seats"></p>
		</div>
	</div>
</div>
{% include 'footer.html' %}
