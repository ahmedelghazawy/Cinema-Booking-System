{% load staticfiles %}
{% include 'navbar.html' %}
<script>
$(document).ready(function(){
	vipSeats = {{screen.vipSeats}}
	standardSeats = {{ screen.standardSeats}}
	clickedSeats = 0;
	seatSelected = []
	seatReserved = []
	getLiveSeats();

	// Initialize the seatSelected
	// seatSelected = new Array((vipSeats + standardSeats)/10);
	// for (i=0;i < (vipSeats + standardSeats)/10; i++){
	// 	seatSelected[i] =[0,0,0,0,0,0,0,0,0,0];
	// }
	// ## Generate the graphical seats
	for ( i = 0; i < vipSeats; i++){
		row = Math.floor(i/10);
		column = i%10;
		$(".theatre").append("<div class='seat freevip' data-column="+column+" data-row="+row+" ></div><!--");
	}
	for ( i = 0; i < standardSeats; i++){
		row = Math.floor(i/10) + Math.floor(vipSeats/10);
		column = i%10;
		$(".theatre").append("<div class='seat free' data-column="+column+" data-row="+row+"></div><!--");
	}
	// ## On form/input change, check the number of seats
	$(".form-control").on("change paste keyup", function() {
		totalSeats = getTotalSeats();
		if (seatSelected.length > totalSeats){
			seatRemoveFIFO(seatSelected.length - totalSeats);
		}
	});
	// ## When a seat is clicked
	$(".seat").click(function(){
		row = $(this).data("row");
		column = $(this).data("column");
		seatPos = String(row)+String(column);
		totalSeats = getTotalSeats();
		if (totalSeats > 0){
			// If the seat is not already reserved
			if (seatReserved.indexOf(seatPos)<0){
				// #1 If the seat is not already clicked
				if (seatSelected.indexOf(seatPos)<0){
					// #1.1 If the seat limit is reached, remove one seat
					if (seatSelected.length >= totalSeats){
						seatRemoveFIFO(1);
					}
					// change the clicked seat and add it to the list
					seatRedraw(seatPos,"black");
					seatSelected.push(seatPos);
				}
				// #2 If the seat is already clicked -> remove the seat
				else{
					seatRemovePos(seatPos);
					seatRedraw(seatPos,"white");
				}
				displaySeats();
			}
		}
		// If no seats were chosen but a seat was clicked
		else{
			alert("Please choose the amount of seats required");
		}
	})
	// Returns a number of seats selected in the Form
	function getTotalSeats() {
    	total = 0;
		$(".form-control").each(function(){
			if (parseInt($(this).val())>0){
				total += parseInt($(this).val());
			}
		})
		return total;
	}
	// Updates the seats numbers displayed for user
	function displaySeats(){
		adjustButton();
		$(".seats").empty();
		for (i=seatSelected.length-1 ; i>=0;i--){
			seat = ""
			if (seatSelected[i].slice(0,1)== "0"){
				seat = seatSelected[i].slice(1,2);
			}else{
				seat = seatSelected[i];
			}
			seat = String(parseInt(seat)+1);
			$(".seats").append("<span style='font-size:20px;'>"+seat+",</span> ");
		}
	}
	// Change the 
	// First In First Out seat removal function
	function seatRemoveFIFO(amount){
		// get first seat, FIFO
		for (i=0;i<amount;i++){
			removeMe = seatSelected.shift();
			seatRedraw(removeMe,"white");
		}
	}
	function seatRemovePos(position){
		var index = seatSelected.indexOf(position);
		if (index >= 0) {
			seatSelected.splice( index, 1 );
		}
	}

	window.setInterval(function(){
		getLiveSeats();
	}, 5000);

	function getLiveSeats(){
		$.getJSON( "/api/seatingapi/{{screening.id}}/", function( data ) {
			// Print live data
			console.log("\n###### Fresh from API ##### \n");
			string = "Seats reserved: ";
			$.each( data, function( key, val ) {
				string += val.row + ":" + val.column + ", ";
			});
			console.log(string);
			// Clear reserved seats
			for (i=0;i<seatReserved.length;i++){
				seatRedraw(seatReserved[i],"white");
			}
			seatReserved = [];
			// Parse new data
			$.each( data, function( key, val) {
				seatReserved.push(String(val.row)+String(val.column));
			});
			// Reverse clicked overlapping seats
			removedString = "";
			for (i=0;i<seatReserved.length;i++){
				if (seatSelected.indexOf(seatReserved[i]) >= 0){
					seatRemovePos(seatReserved[i]);
					removedString+= seatReserved[i]+", ";
				}
			}
			if (removedString.length>1){
				$("#seatAlertNum").append(removedString);
				$("#seatAlert").fadeIn("slow");
				window.setTimeout(function(){
					$("#seatAlert").fadeOut("fast");
				}, 6000);
			}
			// Updates the clicked seats
			displaySeats();
			// Draw all seats
			for (i=0;i<seatReserved.length;i++){
				seatRedraw(seatReserved[i],"orange");
			}
		});
	}

	// Updates a seat on the screen
	function seatRedraw(position,color){
		row = position.slice(0,1);
		column = position.slice(1,3);
		$(".seat[data-row="+row+"][data-column="+column+"]").css("background-color",color);
	}

});
</script>
<link rel="stylesheet" href="{% static 'css/booking.css' %}">
<div class="alert alert-danger" id="seatAlert">
	We are sorry but it seems that the seat <strong id="seatAlertNum"></strong> has just been booked.
</div>
<div class="container">
	<div class = "row">
		<div class="col-lg-3" style="text-align:center;">
			<img src="{% static movie.cover %}" style="width:100%"/>
		</div>
		<div class="col-lg-9">
			<h1>{{movie.title}}</h1>
			<hr style="simpleHR">
			<div class="form-group">
				<label for="normal">Normal:</label>
				<input class="form-control" type="number" name="Normal" min="0" max="99" value="0" id="normal">
				<label for="student">Student:</label>
				<input class="form-control" type="number" name="Student" min="0" max="99" value="0" id="student">
				<label for="senior">Senior:</label>
				<input class="form-control" type="number" name="Senior" min="0" max="99" value="0" id="senior">
				<label for="child">Child:</label>
				<input class="form-control" type="number" name="Child" min="0" max="99" value="0" id="child">
			</div>
			Total:
		</div>
	</div>
	<div class="row" style="padding: 30px 0px 30px 0px;text-align:center">
		<div class="col-lg-6 col-lg-offset-1 col-md-6 col-md-offset-1 ">
			<h1> Theatre {{ screen.id }}</h1>
			<div class="theatre"></div>
		</div>
		<div class="col-lg-4 col-md-4">
			<h1>Legend</h1>
			<hr>
			<br>
			<div class="seat free legend"></div> Standard Avaiable
			<br>
			<div class="seat freevip legend"></div> VIP Avaiable
			<br>
			<div class="seat reserved legend"></div> Reserved
			<h2> Seats Selected</h2>
			<p class="seats"></p>
			<br><br>
			<a  href="/checkout/"><button type="button" class="btn btn-warning">Continue</button></a>
		</div>
	</div>

</div>
{% include 'footer.html' %}
